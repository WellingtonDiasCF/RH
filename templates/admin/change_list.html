{% extends "admin/base.html" %}
{% load i18n admin_urls static admin_list %}

{% block content %}
<div class="rh-page-container">

    {% if cl.opts.model_name == 'funcionario' or cl.opts.model_name == 'equipe' %}
    <div class="d-flex justify-content-center mb-5">
        <ul class="nav nav-pills custom-nav p-1 bg-white border shadow-sm rounded-pill">
            <li class="nav-item">
                <button class="nav-link active rounded-pill px-4 fw-bold" id="tab-admin" data-bs-toggle="pill" data-bs-target="#content-admin" type="button">
                    <i class="fas fa-database me-2"></i> Administração
                </button>
            </li>
            <li class="nav-item">
                {% if cl.opts.model_name == 'equipe' %}
                    <button class="nav-link rounded-pill px-4 fw-bold" data-bs-toggle="pill" data-bs-target="#content-ponto" type="button" onclick="setRhMode('summary'); triggerPainelRH('summary')">
                        <i class="fas fa-chart-pie me-2"></i> Ponto Equipes
                    </button>
                {% else %}
                    <button class="nav-link rounded-pill px-4 fw-bold" data-bs-toggle="pill" data-bs-target="#content-ponto" type="button" onclick="setRhMode('list'); triggerPainelRH('list')">
                        <i class="fas fa-clock me-2"></i> Gestão de Ponto
                    </button>
                {% endif %}
            </li>
            {% if cl.opts.model_name == 'funcionario' %}
            <li class="nav-item">
                <button class="nav-link rounded-pill px-4 fw-bold" data-bs-toggle="pill" data-bs-target="#content-ferias" type="button">
                    <i class="fas fa-umbrella-beach me-2"></i> Férias
                </button>
            </li>
            {% endif %}
        </ul>
    </div>
    {% endif %}

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="content-admin">
            
            <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded-4 shadow-sm border border-light">
                
                <div class="search-wrapper w-100" style="max-width: 450px;">
                    {% if cl.search_fields %}
                    <form id="changelist-search" action="" method="get" class="m-0 position-relative">
                        <i class="fas fa-search position-absolute text-muted" style="left: 20px; top: 50%; transform: translateY(-50%);"></i>
                        
                        {% for pair in cl.params.items %}
                            {% if pair.0 != 'q' %}<input type="hidden" name="{{ pair.0 }}" value="{{ pair.1 }}">{% endif %}
                        {% endfor %}

                        <input type="text" 
                               name="q" 
                               value="{{ cl.query }}" 
                               class="form-control rounded-pill border-0 bg-light ps-5 py-2 shadow-inner instant-search-admin" 
                               placeholder="Pesquisar registro..." 
                               style="height: 45px;"
                               autocomplete="off">
                    </form>
                    {% endif %}
                </div>

                <div class="d-flex gap-2">
                    {% if cl.has_filters %}
                    <button class="btn btn-white rounded-pill px-4 fw-bold border d-flex align-items-center" 
                            type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasFilters" style="height: 45px;">
                        <i class="fas fa-filter text-primary me-2"></i> Filtros
                    </button>
                    {% endif %}
                    
                    <a href="add/" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm d-flex align-items-center" 
                       style="background: #FF6600; border:none; height: 45px; text-decoration: none; color: white;">
                        <i class="fas fa-plus me-2"></i> Novo
                    </a>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <form id="changelist-form" method="post" novalidate>{% csrf_token %}
                    <div class="table-responsive">
                        <table class="table align-middle mb-0 custom-table">
                            <thead class="bg-light">
                                <tr>
                                    {% if cl.opts.model_name == 'funcionario' %}
                                        <th class="ps-4 py-3 text-secondary text-uppercase text-xs fw-bold">Nome Completo</th>
                                        <th class="py-3 text-secondary text-uppercase text-xs fw-bold">Cargo</th>
                                        <th class="py-3 text-secondary text-uppercase text-xs fw-bold">Equipe</th>
                                        <th class="py-3 text-secondary text-uppercase text-xs fw-bold">Local</th>
                                    {% elif cl.opts.model_name == 'equipe' %}
                                        <th class="ps-4 py-3 text-secondary text-uppercase text-xs fw-bold">Nome da Equipe</th>
                                        <th class="py-3 text-secondary text-uppercase text-xs fw-bold">Local</th>
                                        <th class="py-3 text-secondary text-uppercase text-xs fw-bold">Gestores</th>
                                    {% else %}
                                        <th class="ps-4 py-3">Registro</th>
                                    {% endif %}
                                    <th class="text-end pe-4 py-3 text-secondary text-uppercase text-xs fw-bold">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in cl.result_list %}
                                <tr class="hover-row">
                                    {% if cl.opts.model_name == 'funcionario' %}
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle me-3 fw-bold text-white shadow-sm" 
                                                     style="background-color: {% cycle '#FF6600' '#2c3e50' '#27ae60' '#2980b9' %};">
                                                    {{ result.nome_completo|slice:":1" }}
                                                </div>
                                                <div class="d-flex flex-column">
                                                    <span class="fw-bold text-dark">{{ result.nome_completo }}</span>
                                                    <span class="small text-muted">{{ result.email|default:"" }}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ result.cargo|default:"-" }}</td>
                                        <td>{% if result.equipe %}<span class="badge bg-light text-dark border">{{ result.equipe }}</span>{% else %}-{% endif %}</td>
                                        <td>{% if result.local_trabalho_estado %}{{ result.local_trabalho_estado }}{% elif result.equipe.local_trabalho %}{{ result.equipe.local_trabalho }}{% else %}-{% endif %}</td>
                                    
                                    {% elif cl.opts.model_name == 'equipe' %}
                                        <td class="ps-4 fw-bold text-dark">{{ result.nome }}</td>
                                        <td>{{ result.local_trabalho|default:"-" }}</td>
                                        <td>
                                            {% for g in result.gestores.all %}
                                                <span class="badge bg-light text-secondary border me-1">{{ g.nome_completo }}</span>
                                            {% empty %}
                                                <span class="text-muted small">-</span>
                                            {% endfor %}
                                        </td>
                                    
                                    {% else %}
                                        <td class="ps-4">{{ result }}</td>
                                    {% endif %}

                                    <td class="text-end pe-4">
                                        <a href="{% url cl.opts|admin_urlname:'change' result.pk %}" class="btn btn-icon btn-light rounded-circle text-muted" title="Editar">
                                            <i class="fas fa-pen"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5" class="text-center py-5 text-muted">Nenhum registro encontrado.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% block pagination %}
                    <div class="table-footer-clean d-flex justify-content-end align-items-center px-4 py-3 bg-light border-top">
                        <div class="paginator-wrapper">
                            {% pagination cl %}
                        </div>
                    </div>
                    {% endblock %}
                </form>
            </div>
        </div>

        <div class="tab-pane fade" id="content-ponto"><div id="rh-panel-container"></div></div>
        
        <div class="tab-pane fade" id="content-ferias"><div class="text-center py-5"><h4 class="text-muted">Módulo de Férias</h4></div></div>
    </div>
</div>

{% if cl.has_filters %}
<div class="offcanvas offcanvas-end" id="offcanvasFilters">
    <div class="offcanvas-header bg-light border-bottom">
        <h5 class="offcanvas-title fw-bold">Filtros</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div id="changelist-filter" class="p-3">
            {% for spec in cl.filter_specs %}
                <div class="filter-section mb-4">
                    <h6 class="fw-bold text-uppercase text-secondary small mb-2">{{ spec.title }}</h6>
                    <div class="django-filter-content">
                        {% admin_list_filter cl spec %}
                    </div>
                </div>
            {% endfor %}
            <div class="mt-4">
                <a href="?" class="btn btn-outline-danger w-100 rounded-pill fw-bold">Limpar Todos</a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
    /* 1. REMOVER "2 FUNCIONÁRIOS" (TÉCNICA FONT-SIZE 0) */
    /* Isso esconde qualquer texto solto, mas permite restaurar elementos filhos */
    .table-footer-clean, 
    .paginator-wrapper,
    .paginator {
        font-size: 0 !important; 
        line-height: 0;
        color: transparent;
    }
    
    /* Restaura a visibilidade APENAS dos botões e números de página */
    .paginator a, 
    .paginator span.this-page {
        font-size: 0.85rem !important; /* Tamanho normal */
        line-height: normal;
        color: #333 !important;
        display: inline-block;
        padding: 6px 12px;
        border-radius: 6px;
        margin-left: 5px;
        text-decoration: none;
        font-weight: bold;
        background: white;
        border: 1px solid #ddd;
    }
    
    /* Hover e Ativo */
    .paginator a:hover { border-color: #FF6600; color: #FF6600 !important; }
    .paginator span.this-page { background: #FF6600; color: white !important; border-color: #FF6600; }

    /* Esconde spans estatísticos (Total, Show all) */
    .paginator .small, .paginator .quiet { display: none !important; }


    /* 2. CORREÇÃO DOS FILTROS (FORÇAR VISIBILIDADE) */
    /* Remove estilos de lista padrão */
    .django-filter-content ul {
        list-style: none !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    
    .django-filter-content li {
        margin-bottom: 5px !important;
        display: block !important;
    }

    /* Estilo dos Links dos Filtros */
    .django-filter-content li a {
        display: block !important;
        padding: 8px 12px !important;
        background-color: #f8f9fa !important;
        border: 1px solid #eee !important;
        border-radius: 6px !important;
        
        /* OBRIGATÓRIO: Força a cor do texto para ser legível */
        color: #333 !important; 
        font-size: 0.9rem !important;
        text-decoration: none !important;
        font-weight: 500 !important;
    }

    .django-filter-content li a:hover {
        background-color: #e9ecef !important;
        border-color: #ccc !important;
    }

    /* Item selecionado */
    .django-filter-content li.selected a {
        background-color: #FFF3E0 !important;
        color: #FF6600 !important;
        border-color: #FF6600 !important;
        font-weight: bold !important;
    }

    /* Se por acaso for um Select (Dropdown) */
    .django-filter-content select {
        width: 100% !important;
        padding: 8px !important;
        border: 1px solid #ccc !important;
        border-radius: 6px !important;
        background-color: white !important;
        color: #333 !important;
    }


    /* 3. ESTILOS GERAIS */
    .rh-page-container { padding: 30px; max-width: 1600px; margin: 0 auto; overflow: visible !important; }
    .custom-nav .nav-link.active { background-color: #FF6600 !important; color: white !important; }
    .custom-nav .nav-link { color: #555; transition: all 0.3s; }
    
    .custom-table { border-collapse: separate; border-spacing: 0; width: 100%; }
    .custom-table thead th { border-bottom: 1px solid #eee; border-top: none; white-space: nowrap; }
    .custom-table tbody td { border-bottom: 1px solid #f9f9f9; vertical-align: middle; padding: 15px 10px; }
    .hover-row:hover td { background-color: #FFF7ED !important; }
    
    .avatar-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; }
    .btn-icon:hover { background-color: #FF6600; color: white !important; }
    .action-checkbox, .action-checkbox-column, .actions, #action-toggle { display: none !important; }
</style>

<script>
    window.currentRhMode = "{% if cl.opts.model_name == 'equipe' %}summary{% else %}list{% endif %}";
    function setRhMode(mode) { window.currentRhMode = mode; }

    // PESQUISA ADMIN
    let searchTimeout = null;
    const adminSearchInput = document.querySelector('.instant-search-admin');
    const adminSearchForm = document.getElementById('changelist-search');
    if (adminSearchInput && adminSearchForm) {
        adminSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { adminSearchForm.submit(); }, 1000);
        });
        if (adminSearchInput.value.length > 0) {
            adminSearchInput.focus();
            const val = adminSearchInput.value;
            adminSearchInput.value = '';
            adminSearchInput.value = val;
        }
    }

    // PESQUISA PONTO (AJAX)
    document.addEventListener('input', function(e) {
        if (e.target.closest('#rh-panel-container') && e.target.tagName === 'INPUT') {
            clearTimeout(searchTimeout);
            const query = e.target.value;
            searchTimeout = setTimeout(() => {
                let url = `{% url 'admin_gestor_partial' %}?mode=${window.currentRhMode}&q=${encodeURIComponent(query)}`;
                const mesInput = document.querySelector('input[name="mes_atual"]');
                const anoInput = document.querySelector('input[name="ano_atual"]');
                if(mesInput) url += `&mes=${mesInput.value}`;
                if(anoInput) url += `&ano=${anoInput.value}`;
                triggerPainelRH(url);
            }, 600);
        }
    });

    // AJAX + DATA
    function carregarPainelRH(urlOrMode) {
        const c = document.getElementById('rh-panel-container');
        const baseUrl = "{% url 'admin_gestor_partial' %}";
        let finalUrl = '';
        if (urlOrMode === 'list' || urlOrMode === 'summary') finalUrl = `${baseUrl}?mode=${urlOrMode}`;
        else if (urlOrMode.startsWith('?')) finalUrl = `${baseUrl}${urlOrMode}`;
        else finalUrl = urlOrMode;
        c.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
        fetch(finalUrl).then(r => r.text()).then(html => { c.innerHTML = html; });
    }
    window.triggerPainelRH = carregarPainelRH;

    document.addEventListener('click', function(e) {
        const link = e.target.closest('#rh-panel-container a');
        if (link) {
            const href = link.getAttribute('href');
            if(href && (href.startsWith('?') || href.includes('mes=') || href.includes('p='))) {
                e.preventDefault();
                carregarPainelRH(href);
            }
        }
    });

    document.addEventListener("DOMContentLoaded", function() {
        const activeTab = localStorage.getItem('activeAdminTab');
        if (activeTab) {
            const tabBtn = document.querySelector(`button[data-bs-target="${activeTab}"]`);
            if (tabBtn) {
                new bootstrap.Tab(tabBtn).show();
                if(activeTab === '#content-ponto') triggerPainelRH(window.currentRhMode);
            }
        }
        document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(btn => {
            btn.addEventListener('shown.bs.tab', function (e) {
                localStorage.setItem('activeAdminTab', e.target.getAttribute('data-bs-target'));
            });
        });
    });
</script>
{% endblock %}